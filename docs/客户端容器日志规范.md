
# 客户端容器日志规范（Promtail 采集 → Loki）

## 目标

确保 Promtail 能稳定采集、并且你能用 `trace_id / request_id / service` 做全链路排障。

> 重要前提：Promtail 只会推送**日志内容本身为 JSON 字符串**的行；并且 Loki 最终只保留一个 label：`project`。

## 强制约定（必须遵守）

### 1）日志必须是一行一个 JSON 对象

- 每行日志输出必须是一个完整 JSON 对象（不要多行 JSON）
- 任何非 JSON 行都会被 Promtail 丢弃

### 1.1）禁止接管/修改 Root Logger（FastAPI/Uvicorn 默认日志必须保持原样）

**绝对禁止**为了“统一 JSON 日志”而清空/接管 root logger，或替换框架默认 logging 配置（尤其是 Uvicorn/FastAPI 的 access 日志格式）。

- **禁止行为**（示例）：
  - 清空 root handlers、把 root 的 formatter 改成 JSON
  - `logging.basicConfig(...)` 覆盖全局格式
  - 改写 `uvicorn` / `uvicorn.access` / `uvicorn.error` 的 handler/formatter 使其变成 JSON
- **允许行为**：
  - 业务代码使用**独立的应用 logger**（例如 `app`/`biz`），仅给该 logger 配置 JSON formatter
  - 框架日志维持默认格式（它们通常是非 JSON，会被 Promtail 丢弃，从而避免收集大量无意义日志）

### 2）必须包含字段 `service`

`service` 字段用于让 Promtail 派生 `project` label：

- **project 派生规则**：`project = service` 的第一个 `-` 前缀
- 示例：`service="draw-gateway"` → `project="draw"`

### 3）链路追踪相关字段（强制要求）

并非所有日志都需要做链路追踪。这里的字段要求仅针对**链路追踪日志**（例如请求入口、跨服务调用、关键业务事件等）：

**强制约束（必须遵守）**：
- ✅ **如果存在 `task_id`，那么必定有 `trace_id`**
- ✅ **如果存在 `trace_id`，那么必定有 `task_id`**
- ✅ **task_id 和 trace_id 是一对多的关系**（一个 task_id 对应多个 trace_id）

**链路追踪日志必须包含的字段**：
- `task_id`：任务 ID（格式建议：`task_<标识符>`，如 `task_abc123`）
- `trace_id`：32 位十六进制字符串（与 Tempo trace id 对齐）

**强烈建议同时包含**：
- `span_id`：16 位十六进制字符串
- `request_id`：请求 ID

**字段关系说明**：
- `task_id` 和 `trace_id` **强制绑定**，必须成对出现
- 一个 task_id 对应多个 trace_id（一对多关系）
- 用 `trace_id` 追踪单次执行的详细链路
- 用 `task_id` 追踪任务的所有执行历史（首次执行、重试等）

**对于普通运行日志**：不需要包含 trace_id/task_id/span_id/request_id。

### 4）其它建议字段（可选）

- `ts`：时间戳（RFC3339 或毫秒时间戳均可，保持一致）
- `level`：日志级别（info/warn/error）— **建议包含**，TraceLogKit 会基于 `level="error"` 做日志错误率统计和告警
- `msg`：人类可读消息
- `event`：结构化事件名（便于检索/聚合）
- `duration_ms`：耗时（如适用）

## 字段示例

**链路追踪日志示例**（必须同时包含 task_id 和 trace_id）：
```json
{"ts":"2026-02-12T12:34:56.789Z","level":"info","service":"draw-gateway","task_id":"task_abc123","trace_id":"0123456789abcdef0123456789abcdef","span_id":"89abcdef01234567","request_id":"req_456","event":"task.started","msg":"任务开始处理"}
```

**普通运行日志示例**（不包含链路追踪字段）：
```json
{"ts":"2026-02-12T12:34:56.789Z","level":"info","service":"draw-gateway","event":"app.startup","msg":"应用启动完成"}
```

## 查询示例（Grafana / LogQL）

### 按 trace_id 查全链路日志（单次执行）

```logql
{project="draw"} | json | trace_id="0123456789abcdef0123456789abcdef"
```

### 按 request_id 查该请求日志

```logql
{project="draw"} | json | request_id="req_123"
```

### 按 task_id 查任务的所有执行日志（包含所有重试）

```logql
{project=~".+"} | json | task_id="task_abc123"
```

**说明**：
- 用 `trace_id` 查询时，返回**单次执行**的所有日志（一条完整链路）
- 用 `task_id` 查询时，返回**任务的所有执行**日志（包括首次执行、重试等）
- **一对多关系**：同一个 `task_id` 对应多个 `trace_id`
- **强制约束**：trace_id 和 task_id **必须成对出现**，不能只有其中一个

### 按 task_id + service 过滤

```logql
{project="draw"} | json | task_id="task_abc123" | service="draw-gateway"
```

### 统计某任务的 trace 数量（执行次数）

```logql
count(count_over_time({project="draw"} | json | task_id="task_abc123" | __error__="" [24h]) by (trace_id))
```

### 同一个 trace 内按 service 过滤

```logql
{project="draw"} | json | trace_id="..." | service="draw-gateway"
```
