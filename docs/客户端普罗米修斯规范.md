
# 客户端 Prometheus（Metrics）暴露规范

## 目标

让你能把**指标（Prometheus）**和**日志（Loki）**、**追踪（Tempo）**在排障时对齐到同一个维度：

- `project`：项目维度（与 Loki label `project`、Tempo resource attribute `project` 一致）
- `service`：服务维度（与 `service.name` / 日志 `service` 一致）

## 强制约定（必须遵守）

- **必须暴露 HTTP 指标端点**：`GET /metrics`
- **必须提供静态标签（推荐方式）**：
  - `project="<project>"`
  - `service="<service>"`（或使用 Prometheus 标准 `job`/`instance` 再配合抓取侧 relabel，但推荐显式提供）
- **禁止高基数 label**（严禁出现在 metrics labels 中）：
  - `trace_id` / `span_id` / `request_id` / `task_id` / `user_id` / `order_id` 等

> 说明：trace_id 等可以通过 tracing/日志关联，不应该进入 Prometheus label，否则会导致时序爆炸。

## project/service 值规范

- `service`：建议使用容器/服务名，例如 `draw-gateway`
- `project`：与服务名派生一致：`project = service` 的第一个 `-` 前缀，例如 `draw`

## 与 Tracing 的关联（可选增强）

如果你使用 OpenTelemetry Metrics（或支持 exemplars 的 Prometheus client），建议：

- 在 histogram/summary 上开启 exemplars（如果你的链路系统支持），exemplar 里携带 trace_id
- 这样可以从指标直接跳到 trace（Grafana 里体验更好）

## 最小可用指标集合（建议）

至少应提供以下一类指标（按你的业务选择）：

- HTTP 请求
  - `http_server_requests_total`（counter）
  - `http_server_request_duration_seconds_bucket`（histogram）
- 任务/队列（如有）
  - `task_processed_total`
  - `task_duration_seconds_bucket`

