
# 客户端 Prometheus（Metrics）暴露规范

## 目标

让你能把**指标（Prometheus）**和**日志（Loki）**、**追踪（Tempo）**在排障时对齐到同一个维度：

- `project`：项目维度（与 Loki label `project`、Tempo resource attribute `project` 一致）
- `service`：服务维度（与 `service.name` / 日志 `service` 一致）

## 强制约定（必须遵守）

- **必须暴露 HTTP 指标端点**：`GET /metrics`
- **必须提供静态标签（推荐方式）**：
  - `project="<project>"`
  - `service="<service>"`（或使用 Prometheus 标准 `job`/`instance` 再配合抓取侧 relabel，但推荐显式提供）
- **禁止高基数 label**（严禁出现在 metrics labels 中）：
  - `trace_id` / `span_id` / `request_id` / `task_id` / `user_id` / `order_id` 等
- **必须排除探针类请求**：统计 HTTP 请求指标时，**不得**将 `/health`、`/ping`、`/metrics`、`/ready`、`/live` 等探针/健康检查请求计入 `http_server_requests_total` 或 `http_requests_total` 等业务指标，否则会污染数据，导致错误率、延迟等统计不准确。

> 说明：trace_id 等可以通过 tracing/日志关联，不应该进入 Prometheus label，否则会导致时序爆炸。

## project/service 值规范

- `service`：建议使用容器/服务名，例如 `draw-gateway`
- `project`：与服务名派生一致：`project = service` 的第一个 `-` 前缀，例如 `draw`

## 与 Tracing 的关联（可选增强）

如果你使用 OpenTelemetry Metrics（或支持 exemplars 的 Prometheus client），建议：

- 在 histogram/summary 上开启 exemplars（如果你的链路系统支持），exemplar 里携带 trace_id
- 这样可以从指标直接跳到 trace（Grafana 里体验更好）

## 最小可用指标集合（建议）

至少应提供以下一类指标（按你的业务选择）：

### HTTP 请求

二者**不是二选一**，可同时存在，代表不同聚合层级：

| 对比项 | `http_server_requests_total` | `http_requests_total` |
|--------|------------------------------|------------------------|
| **聚合维度** | `job`：分布式工作流请求 | `service`：容器服务 |
| **层级关系** | 工作流整体 | 工作流中的一个节点（容器服务） |
| **状态码 label** | **统一使用 `code`**，取值三位数字：`"200"`、`"404"`、`"500"` | **统一使用 `code`**，取值三位数字：`"200"`、`"404"`、`"500"` |

- 一个分布式工作流（job）可包含多个容器服务（service），因此两类指标可并存
- **两种指标均必须包含 `code` label**，用于区分 4xx/5xx 错误
- 两种指标均需**排除探针路径**：`/health`、`/ping`、`/metrics`、`/ready`、`/live` 等不应计入

- `http_server_request_duration_seconds_bucket`（histogram，可选）
  - 同样需排除上述探针路径，否则延迟统计会被探针请求干扰

### 任务/队列（如有）

- `task_processed_total`
- `task_duration_seconds_bucket`

## 监控目标配置（部署侧）

TraceLogKit 通过 `docker/prometheus/targets/` 目录下的 YAML 文件配置抓取目标。将你的服务加入监控：

1. 参考 `docker/prometheus/targets/example.yml.example` 编写配置
2. 复制并重命名为 `.yml` 扩展名（如 `my-project.yml`）
3. 确保服务与 Prometheus 在同一 Docker 网络中，或使用可访问的 host:port

符合上述规范的服务，TraceLogKit 将自动在 Grafana 中展示错误率，并在错误率超过 5%（成功率低于 95%）时触发告警。

